name: Cron Jobs

permissions:
  contents: read

on:
  schedule:
    # Daily at Midnight UTC (Sync Candles, Watchers)
    - cron: '0 0 * * *'
    # Hourly (Risk Scanner, Posts Sync)
    - cron: '0 * * * *'
    # Every 5 mins during market hours (6 AM - 9 PM UTC covers both EU and US)
    - cron: '*/5 6-21 * * 1-5'
    # Every 5 minutes (Digest, Queue Processing)
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  daily-jobs:
    runs-on: ubuntu-latest
    environment: prod
    if: github.event.schedule == '0 0 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Daily Candle Sync
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/sync-daily-candles -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Daily Watchers Sync
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/stocktwits/jobs/sync-watchers -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

  hourly-jobs:
    runs-on: ubuntu-latest
    environment: prod
    if: github.event.schedule == '0 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Risk/Reward Scanner
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/run-risk-reward-scanner -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Hourly Posts Sync
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/stocktwits/jobs/sync-posts -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Research Cleanup (Zombie Tickets)
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/cleanup-research -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

  # Light snapshot sync every 30 mins during market hours (Mon-Fri, 6 AM - 9 PM UTC)
  snapshot-sync:
    runs-on: ubuntu-latest
    environment: prod
    if: github.event.schedule == '*/30 6-21 * * 1-5'
    steps:
      - name: Trigger Snapshot Sync
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/sync-snapshots -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

  # Frequent jobs (Every 5 mins)
  frequent-jobs:
    runs-on: ubuntu-latest
    environment: prod
    if: github.event.schedule == '*/5 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Daily Digest Generation
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/daily-digest -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Process Request Queue
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/jobs/process-requests -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Top Picks Refresh
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/tickers/cron/refresh-top-picks -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"

      - name: Trigger Portfolio Refresh
        run: curl -X POST ${{ vars.CLOUD_RUN_URL }}/api/v1/tickers/cron/refresh-portfolios -H "X-Cron-Secret:${{ secrets.CRON_SECRET }}" -H "Content-Type:application/json"
