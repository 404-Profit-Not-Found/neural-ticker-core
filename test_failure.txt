
> neural-ticker-core@0.3.0 test
> jest src/modules/market-data/market-data.service.spec.ts

  console.log
    [dotenv@17.2.3] injecting env (15) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

[Nest] 15964  - 11. 01. 2026 0:38:53   ERROR [MarketDataService] Failed to sync history for AAPL: this.ohlcvRepo.upsert is not a function
[Nest] 15964  - 11. 01. 2026 0:38:53   ERROR [MarketDataService] TypeError: this.ohlcvRepo.upsert is not a function
    at MarketDataService.syncTickerHistory (C:\Users\brani\Documents\GitHub\neural-ticker-core\src\modules\market-data\market-data.service.ts:657:28)
    at Object.<anonymous> (C:\Users\brani\Documents\GitHub\neural-ticker-core\src\modules\market-data\market-data.service.spec.ts:649:7)
FAIL src/modules/market-data/market-data.service.spec.ts
  MarketDataService
    ΓêÜ should be defined (9 ms)
    getSnapshot
      ΓêÜ should return cached data if fresh (4 ms)
      ΓêÜ should fetch from Finnhub if cached price is stale (4 ms)
    getCompanyNews
      ΓêÜ should return news from Finnhub (3 ms)
    upsertAnalystRatings
      ΓêÜ should skip ratings with no firm (2 ms)
      ΓêÜ should skip ratings with no rating_date or invalid date (3 ms)
      ΓêÜ should skip ratings where rating value is null or undefined (3 ms)
      ΓêÜ should upsert valid rating if not exists (2 ms)
    getAnalyzerTickers
      ΓêÜ should return paginated data with correct structure (6 ms)
      ΓêÜ should apply search filter when provided (2 ms)
      ΓêÜ should filter out bankrupt shadowbanned tickers for admin (1 ms)
      ΓêÜ should filter by overallScore (Risk/Reward) (1 ms)
      ΓêÜ should apply dynamic upside filter when provided (2 ms)
      ΓêÜ should apply dynamic sorting for upside_percent (1 ms)
    getSnapshots
      ΓêÜ should fetch snapshots for multiple symbols in chunks (2 ms)
    syncTickerHistory
      ΓêÜ should skip if ticker not found (1 ms)
      ΓêÜ should skip if coverage is already high (1 ms)
      ├ù should fetch from Yahoo if coverage is low (29 ms)

  ΓùÅ MarketDataService ΓÇ║ syncTickerHistory ΓÇ║ should fetch from Yahoo if coverage is low

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      649 |       await service.syncTickerHistory('AAPL', 1);
      650 |       expect(mockYahooService.getHistorical).toHaveBeenCalled();
    > 651 |       expect(mockOhlcvRepo.save).toHaveBeenCalled();
          |                                  ^
      652 |     });
      653 |   });
      654 | });

      at Object.<anonymous> (modules/market-data/market-data.service.spec.ts:651:34)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 17 passed, 18 total
Snapshots:   0 total
Time:        1.547 s, estimated 2 s
Ran all test suites matching src/modules/market-data/market-data.service.spec.ts.
